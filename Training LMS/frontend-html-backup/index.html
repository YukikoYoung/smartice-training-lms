<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LMSåŸ¹è®­ç³»ç»Ÿ - é¤é¥®è¿é”ä¼ä¸šç‰ˆ</title>

  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f0f2f5;
    }

    #app {
      height: 100vh;
      overflow: hidden;
    }

    /* ç™»å½•é¡µé¢æ ·å¼ */
    .login-container {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-box {
      width: 400px;
      padding: 40px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .login-title {
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .login-subtitle {
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
      color: #999;
    }

    /* ä¸»å¸ƒå±€æ ·å¼ */
    .main-layout {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-header {
      background: white;
      border-bottom: 1px solid #e8e8e8;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 60px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .logo {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
    }

    .main-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 200px;
      background: white;
      border-right: 1px solid #e8e8e8;
      overflow-y: auto;
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    /* å¡ç‰‡æ ·å¼ */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin: 10px 0;
    }

    .stat-card .label {
      color: #999;
      font-size: 14px;
    }

    /* è¯¾ç¨‹å¡ç‰‡ */
    .course-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .course-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
      cursor: pointer;
    }

    .course-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .course-cover {
      width: 100%;
      height: 180px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 48px;
    }

    .course-info {
      padding: 15px;
    }

    .course-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .course-meta {
      display: flex;
      justify-content: space-between;
      color: #999;
      font-size: 12px;
      margin-top: 10px;
    }

    /* è§†é¢‘æ’­æ”¾å™¨ */
    .video-player {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    /* è€ƒè¯•ç•Œé¢ */
    .exam-question {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .question-title {
      font-size: 16px;
      margin-bottom: 15px;
      line-height: 1.6;
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .dashboard-cards {
        grid-template-columns: repeat(2, 1fr);
      }

      .course-grid {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: absolute;
        left: -200px;
        height: calc(100vh - 60px);
        z-index: 1000;
        transition: left 0.3s;
      }

      .sidebar.mobile-show {
        left: 0;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- ç™»å½•é¡µé¢ -->
    <div v-if="!isLoggedIn" class="login-container">
      <div class="login-box">
        <div class="login-title">ğŸ“ LMSåŸ¹è®­ç³»ç»Ÿ</div>
        <div class="login-subtitle">é¤é¥®è¿é”ä¼ä¸šåŸ¹è®­ç®¡ç†å¹³å°</div>

        <el-form :model="loginForm" label-width="0">
          <el-form-item>
            <el-input
              v-model="loginForm.email"
              placeholder="é‚®ç®±"
              size="large"
              prefix-icon="User">
            </el-input>
          </el-form-item>

          <el-form-item>
            <el-input
              v-model="loginForm.password"
              type="password"
              placeholder="å¯†ç "
              size="large"
              prefix-icon="Lock"
              @keyup.enter="handleLogin">
            </el-input>
          </el-form-item>

          <el-form-item>
            <el-button
              type="primary"
              size="large"
              style="width: 100%"
              :loading="loginLoading"
              @click="handleLogin">
              ç™»å½•
            </el-button>
          </el-form-item>

          <div style="text-align: center; margin-top: 10px;">
            <el-link type="primary" @click="showDemoAccounts">æŸ¥çœ‹æ¼”ç¤ºè´¦å·</el-link>
          </div>
        </el-form>
      </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div v-else class="main-layout">
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <div class="main-header">
        <div class="logo">ğŸ“ LMSåŸ¹è®­ç³»ç»Ÿ</div>
        <div>
          <el-dropdown @command="handleUserCommand">
            <span class="el-dropdown-link">
              <el-avatar :size="32" style="margin-right: 8px;">
                {{ currentUser?.name?.charAt(0) || 'U' }}
              </el-avatar>
              {{ currentUser?.name || 'ç”¨æˆ·' }}
              <el-icon class="el-icon--right"><arrow-down /></el-icon>
            </span>
            <template #dropdown>
              <el-dropdown-menu>
                <el-dropdown-item>{{ getRoleName(currentUser?.role) }}</el-dropdown-item>
                <el-dropdown-item v-if="currentUser?.store">{{ currentUser.store.store_name }}</el-dropdown-item>
                <el-dropdown-item divided command="logout">é€€å‡ºç™»å½•</el-dropdown-item>
              </el-dropdown-menu>
            </template>
          </el-dropdown>
        </div>
      </div>

      <!-- ä¸»ä½“å†…å®¹ -->
      <div class="main-body">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
          <el-menu
            :default-active="currentView"
            @select="handleMenuSelect">
            <el-menu-item index="dashboard">
              <el-icon><DataAnalysis /></el-icon>
              <span>æ•°æ®çœ‹æ¿</span>
            </el-menu-item>

            <el-menu-item index="my-courses" v-if="currentUser?.role === 'student'">
              <el-icon><Reading /></el-icon>
              <span>æˆ‘çš„è¯¾ç¨‹</span>
            </el-menu-item>

            <el-menu-item index="courses" v-if="isTrainer">
              <el-icon><Management /></el-icon>
              <span>è¯¾ç¨‹ç®¡ç†</span>
            </el-menu-item>

            <el-menu-item index="exams" v-if="isTrainer">
              <el-icon><Edit /></el-icon>
              <span>è€ƒè¯•ç®¡ç†</span>
            </el-menu-item>

            <el-menu-item index="students" v-if="isManager">
              <el-icon><User /></el-icon>
              <span>å­¦å‘˜ç®¡ç†</span>
            </el-menu-item>

            <el-menu-item index="stores" v-if="isAdmin">
              <el-icon><OfficeBuilding /></el-icon>
              <span>é—¨åº—ç®¡ç†</span>
            </el-menu-item>

            <el-menu-item index="stats">
              <el-icon><TrendCharts /></el-icon>
              <span>ç»Ÿè®¡åˆ†æ</span>
            </el-menu-item>
          </el-menu>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content">
          <!-- æ•°æ®çœ‹æ¿ -->
          <div v-if="currentView === 'dashboard'">
            <h2 style="margin-bottom: 20px;">æ•°æ®çœ‹æ¿</h2>
            <div class="dashboard-cards">
              <div class="stat-card">
                <div class="label">æ€»å­¦å‘˜æ•°</div>
                <div class="value">{{ dashboardStats.total_students || 0 }}</div>
              </div>
              <div class="stat-card">
                <div class="label">è¯¾ç¨‹æ€»æ•°</div>
                <div class="value">{{ dashboardStats.total_courses || 0 }}</div>
              </div>
              <div class="stat-card">
                <div class="label">å®Œæˆè¯¾ç¨‹æ•°</div>
                <div class="value">{{ dashboardStats.completed_courses || 0 }}</div>
              </div>
              <div class="stat-card">
                <div class="label">è€ƒè¯•é€šè¿‡ç‡</div>
                <div class="value">{{ dashboardStats.exam_pass_rate || 0 }}%</div>
              </div>
            </div>

            <el-card style="margin-top: 20px;">
              <template #header>
                <div style="display: flex; justify-content: space-between;">
                  <span>ğŸ† å­¦ä¹ æ—¶é•¿æ’è¡Œæ¦œ</span>
                  <el-link type="primary" @click="loadRanking('study_time')">åˆ·æ–°</el-link>
                </div>
              </template>
              <el-table :data="rankingList" stripe>
                <el-table-column type="index" label="æ’å" width="80" />
                <el-table-column prop="user_name" label="å§“å" />
                <el-table-column prop="display_value" label="å­¦ä¹ æ—¶é•¿" />
              </el-table>
            </el-card>
          </div>

          <!-- æˆ‘çš„è¯¾ç¨‹ï¼ˆå­¦å‘˜è§†å›¾ï¼‰ -->
          <div v-if="currentView === 'my-courses'">
            <h2 style="margin-bottom: 20px;">æˆ‘çš„è¯¾ç¨‹</h2>
            <div class="course-grid">
              <div
                v-for="course in myCourses"
                :key="course.id"
                class="course-card"
                @click="openCourse(course)">
                <div class="course-cover">ğŸ“š</div>
                <div class="course-info">
                  <div class="course-title">{{ course.course_name }}</div>
                  <div style="margin: 10px 0;">
                    <el-progress
                      :percentage="course.progress || 0"
                      :color="course.progress === 100 ? '#67C23A' : '#409EFF'" />
                  </div>
                  <div class="course-meta">
                    <span>
                      <el-tag v-if="course.is_required" type="danger" size="small">å¿…ä¿®</el-tag>
                      <el-tag v-else type="info" size="small">é€‰ä¿®</el-tag>
                    </span>
                    <span>{{ course.completed_contents }}/{{ course.total_contents }} ç« èŠ‚</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- è¯¾ç¨‹ç®¡ç†ï¼ˆåŸ¹è®­è´Ÿè´£äººè§†å›¾ï¼‰ -->
          <div v-if="currentView === 'courses'">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
              <h2>è¯¾ç¨‹ç®¡ç†</h2>
              <el-button type="primary" @click="openCourseDialog">+ åˆ›å»ºè¯¾ç¨‹</el-button>
            </div>

            <el-table :data="coursesList" stripe>
              <el-table-column prop="course_name" label="è¯¾ç¨‹åç§°" />
              <el-table-column prop="course_type" label="ç±»å‹" width="120">
                <template #default="{ row }">
                  <el-tag v-if="row.course_type === 'position'">å²—ä½è¯¾ç¨‹</el-tag>
                  <el-tag v-else-if="row.course_type === 'general'" type="success">é€šè¯†è¯¾ç¨‹</el-tag>
                  <el-tag v-else type="warning">ä¸“é¡¹åŸ¹è®­</el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="difficulty" label="éš¾åº¦" width="100" />
              <el-table-column prop="status" label="çŠ¶æ€" width="100">
                <template #default="{ row }">
                  <el-tag v-if="row.status === 'PUBLISHED'" type="success">å·²å‘å¸ƒ</el-tag>
                  <el-tag v-else-if="row.status === 'DRAFT'" type="info">è‰ç¨¿</el-tag>
                  <el-tag v-else type="warning">å·²å½’æ¡£</el-tag>
                </template>
              </el-table-column>
              <el-table-column label="æ“ä½œ" width="200">
                <template #default="{ row }">
                  <el-button size="small" @click="editCourse(row)">ç¼–è¾‘</el-button>
                  <el-button size="small" type="danger" @click="deleteCourse(row)">åˆ é™¤</el-button>
                </template>
              </el-table-column>
            </el-table>
          </div>

          <!-- ç»Ÿè®¡åˆ†æ -->
          <div v-if="currentView === 'stats'">
            <h2 style="margin-bottom: 20px;">ç»Ÿè®¡åˆ†æ</h2>

            <el-tabs v-model="statsTab">
              <el-tab-pane label="å­¦ä¹ è¿›åº¦" name="progress">
                <el-table :data="progressStats" stripe>
                  <el-table-column prop="user_name" label="å­¦å‘˜å§“å" />
                  <el-table-column prop="total_courses" label="å­¦ä¹ è¯¾ç¨‹æ•°" width="120" />
                  <el-table-column prop="completed_courses" label="å®Œæˆè¯¾ç¨‹æ•°" width="120" />
                  <el-table-column prop="progress_rate" label="å®Œæˆç‡" width="120">
                    <template #default="{ row }">
                      {{ row.progress_rate }}%
                    </template>
                  </el-table-column>
                </el-table>
              </el-tab-pane>

              <el-tab-pane label="è€ƒè¯•æˆç»©" name="scores">
                <el-table :data="examScores" stripe>
                  <el-table-column prop="user.name" label="å­¦å‘˜å§“å" />
                  <el-table-column prop="exam.exam_name" label="è€ƒè¯•åç§°" />
                  <el-table-column prop="score" label="åˆ†æ•°" width="100" />
                  <el-table-column prop="is_passed" label="æ˜¯å¦é€šè¿‡" width="100">
                    <template #default="{ row }">
                      <el-tag v-if="row.is_passed" type="success">é€šè¿‡</el-tag>
                      <el-tag v-else type="danger">æœªé€šè¿‡</el-tag>
                    </template>
                  </el-table-column>
                  <el-table-column prop="submit_time" label="æäº¤æ—¶é—´" width="180" />
                </el-table>
              </el-tab-pane>
            </el-tabs>
          </div>
        </div>
      </div>
    </div>

    <!-- åˆ›å»ºè¯¾ç¨‹å¯¹è¯æ¡† -->
    <el-dialog
      v-model="courseDialogVisible"
      title="åˆ›å»ºè¯¾ç¨‹"
      width="600px">
      <el-form :model="courseForm" label-width="100px">
        <el-form-item label="è¯¾ç¨‹åç§°">
          <el-input v-model="courseForm.course_name" />
        </el-form-item>
        <el-form-item label="è¯¾ç¨‹ç±»å‹">
          <el-select v-model="courseForm.course_type" style="width: 100%">
            <el-option label="å²—ä½è¯¾ç¨‹" value="position" />
            <el-option label="é€šè¯†è¯¾ç¨‹" value="general" />
            <el-option label="ä¸“é¡¹åŸ¹è®­" value="special" />
          </el-select>
        </el-form-item>
        <el-form-item label="éš¾åº¦">
          <el-select v-model="courseForm.difficulty" style="width: 100%">
            <el-option label="åŸºç¡€" value="basic" />
            <el-option label="ä¸­çº§" value="intermediate" />
            <el-option label="é«˜çº§" value="advanced" />
          </el-select>
        </el-form-item>
        <el-form-item label="è¯¾ç¨‹æè¿°">
          <el-input v-model="courseForm.description" type="textarea" :rows="4" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="courseDialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="saveCourse">ä¿å­˜</el-button>
      </template>
    </el-dialog>
  </div>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3.3.11/dist/vue.global.js"></script>
  <!-- Element Plus -->
  <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
  <!-- Element Plus Icons -->
  <script src="https://unpkg.com/@element-plus/icons-vue@2.1.0/dist/index.iife.min.js"></script>
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>

  <script src="./app.js"></script>
</body>
</html>
